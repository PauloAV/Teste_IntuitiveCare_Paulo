# üè• Teste T√©cnico - Engenharia de Dados (ANS)

Este projeto realiza o pipeline de dados (ETL) completo: extra√ß√£o, transforma√ß√£o, carregamento (Load) e an√°lise de Demonstra√ß√µes Cont√°beis das operadoras de planos de sa√∫de, provenientes dos Dados Abertos da ANS.

## üöÄ Funcionalidades

### 1. Extra√ß√£o Autom√°tica (`src/etl/extraction.py`)
- **Automa√ß√£o de Datas:** O script calcula automaticamente a data atual e busca os √∫ltimos 3 trimestres dispon√≠veis.
- **Margem de Seguran√ßa:** L√≥gica de "lag" (atraso) de 120 dias para respeitar o calend√°rio de publica√ß√£o da ANS.
- **Resili√™ncia:** Tratamento de erros de conex√£o e verifica√ß√£o de integridade (hash/tamanho) dos arquivos ZIP.

### 2. Transforma√ß√£o e Enriquecimento (`src/etl/analysis/complete_analysis.py`)
- **Limpeza:** Padroniza√ß√£o de encoding (`Latin1` para `UTF-8`) e tratamento de separadores CSV.
- **Enriquecimento:** Cruzamento de dados financeiros com dados cadastrais (Cadop) via CNPJ.
- **Valida√ß√£o:** Verifica√ß√£o autom√°tica de integridade de CNPJ (M√≥dulo 11).

### 3. Banco de Dados e Carga (`src/etl/load.py` & `database/`)
- **Pipeline SQL:** Orquestra√ß√£o autom√°tica de scripts `.sql` numerados para garantir a ordem de execu√ß√£o (DDL -> DML -> DQL).
- **Seguran√ßa:** Uso de vari√°veis de ambiente (`.env`) para ocultar credenciais do banco.
- **Performance:** Utiliza√ß√£o de `LOAD DATA LOCAL INFILE` para ingest√£o em massa (bulk load) de arquivos CSV.

---

## üõ†Ô∏è Decis√µes T√©cnicas (Trade-offs)

### 1. Estrat√©gia de Processamento (Item 1.2)
Optei pelo processamento **em mem√≥ria (In-Memory)** utilizando Pandas.
- **Justificativa:** O volume total dos arquivos trimestrais (aprox. 150MB) cabe confortavelmente na RAM. O processamento em stream (chunks) adicionaria complexidade desnecess√°ria para este volume.

### 2. Valida√ß√£o de Dados (Item 2.1)
**Desafio:** Como tratar registros financeiros com CNPJs matematicamente inv√°lidos?
- **Estrat√©gia:** *Flagging & Keeping* (Sinalizar e Manter).
- **Justificativa:** Em auditorias cont√°beis, a integridade da soma financeira √© priorit√°ria. Um erro de digita√ß√£o no cadastro do CNPJ n√£o anula a exist√™ncia da despesa monet√°ria.

### 3. Enriquecimento e Joins (Item 2.2)
**Desafio:** Garantir que despesas n√£o sejam perdidas se a operadora n√£o estiver no cadastro (Cadop).
- **Estrat√©gia:** `Left Join` utilizando o CNPJ.
- **Justificativa:** Garante a integridade financeira. Campos cadastrais faltantes s√£o preenchidos com "N/D".
- **Deduplica√ß√£o:** O Cadop sofre `drop_duplicates(keep='last')` antes do join para evitar produto cartesiano (multiplica√ß√£o de linhas).

### 4. Modelagem de Dados (Item 3.2)
**Trade-off: Normaliza√ß√£o vs Desnormaliza√ß√£o**
- **Estrat√©gia:** H√≠brida.
    - **Tabela `operadoras`:** Normalizada (3FN). Endere√ßos foram separados em uma tabela `enderecos_operadoras` para evitar redund√¢ncia e anomalias de atualiza√ß√£o.
    - **Tabela `despesas_agregadas`:** Desnormalizada.
- **Justificativa:** A normaliza√ß√£o facilita a manuten√ß√£o cadastral, enquanto a tabela agregada desnormalizada otimiza a leitura para dashboards anal√≠ticos (BI), evitando JOINs custosos em tempo de leitura.

### 5. Ingest√£o e Encoding (Item 3.3)
**Desafio:** Arquivos fonte em `Latin1` vs Banco de dados em `UTF-8`.
- **Solu√ß√£o:** Tabelas criadas com charset `utf8mb4`. Comando de importa√ß√£o configurado com `CHARACTER SET latin1`.
- **Justificativa:** Delega ao MySQL a tarefa de convers√£o de encoding durante a ingest√£o, garantindo que acentos (ex: "S√£o Paulo") sejam armazenados corretamente sem corromper os dados originais.

### 6. Queries Anal√≠ticas (Item 3.4)
**Desafio:** Comparar performance de operadoras com dados faltantes.
- **Estrat√©gia:** Uso de `Common Table Expressions (CTEs)` e agrega√ß√£o pr√©via (`SUM/GROUP BY`).
- **Justificativa:**
    - **CTEs:** Melhoram a legibilidade e manuten√ß√£o do c√≥digo em compara√ß√£o a subqueries aninhadas.
    - **Agrega√ß√£o:** Necess√°ria para tratar casos onde uma operadora possui m√∫ltiplos lan√ßamentos no mesmo trimestre, evitando distor√ß√µes no ranking de crescimento.

---

## üìä Arquivos Gerados (`data/processed/`)

1. **`consolidado.csv`**: Base completa de despesas enriquecida.
2. **`despesas_agregadas.csv`**: Relat√≥rio anal√≠tico final (Totais, M√©dia, Desvio Padr√£o).
3. **`demonstracoes_contabeis_consolidadas.zip`**: Entrega final compactada.

---

## üì¶ Como Executar

### Pr√©-requisitos
- Python 3.11+
- MySQL Server 8.0+

### Passo 1: Configura√ß√£o do Ambiente
1. Crie um ambiente virtual e instale as depend√™ncias:
   ```bash
   python -m venv .venv
   # Windows:
   .venv\Scripts\activate
   # Linux/Mac:
   source .venv/bin/activate
   
   pip install -r requirements.txt